<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2W12 Audio Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #fafafa;
            --text-primary: #1a1a1a;
            --text-secondary: #8e8e8e;
            --text-muted: #999;
            --border-color: #e1e1e1;
            --accent-color: #777777;
            --hover-bg: #f5f5f5;
            --card-bg: #eeeeee;
            --glitch-color: #ff0080;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            font-weight: 300;
            letter-spacing: -0.01em;
            overflow-x: hidden;
        }
        
        /* Clean Layout - No Sidebar */
        .layout {
            min-height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .main-content {
            width: 100%;
            padding: 0;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            letter-spacing: -0.02em;
        }
        
        .subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 300;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        
        .glitch-text {
            position: relative;
            display: inline-block;
        }
        
        .glitch-text::before,
        .glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
        }
        
        .glitch-text::before {
            left: 2px;
            text-shadow: -2px 0 var(--glitch-color);
            clip: rect(24px, 550px, 90px, 0);
            animation: glitch-anim-1 3s infinite linear alternate-reverse;
        }
        
        .glitch-text::after {
            left: -2px;
            text-shadow: -2px 0 var(--accent-color);
            clip: rect(85px, 550px, 140px, 0);
            animation: glitch-anim-2 2s infinite linear alternate-reverse;
        }
        
        @keyframes glitch-anim-1 {
            0% { clip: rect(64px, 9999px, 90px, 0); }
            5% { clip: rect(30px, 9999px, 90px, 0); }
            10% { clip: rect(74px, 9999px, 90px, 0); }
            100% { clip: rect(64px, 9999px, 90px, 0); }
        }
        
        @keyframes glitch-anim-2 {
            0% { clip: rect(85px, 9999px, 140px, 0); }
            5% { clip: rect(95px, 9999px, 140px, 0); }
            10% { clip: rect(100px, 9999px, 140px, 0); }
            100% { clip: rect(85px, 9999px, 140px, 0); }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'IBM Plex Mono', 'monospace']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'progress': 'progress 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        progress: { '0%': { transform: 'scaleX(0)' }, '100%': { transform: 'scaleX(1)' } }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@300;400;500&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body style="background: var(--bg-color); color: var(--text-primary);">
    <div class="layout">
        <!-- Main Content -->
        <main class="main-content">
        
        <!-- Header -->
        <header style="margin-bottom: 3rem; text-align: center;">
            <div style="margin-bottom: 2rem;">
                <h1 class="glitch-text" data-text="2W12" style="font-size: 3rem; font-weight: 600; margin-bottom: 0.5rem; letter-spacing: -0.02em; color: var(--text-primary); font-family: 'Inter', sans-serif;">
                    2W12
                </h1>
                <p style="font-size: 1.1rem; color: var(--text-secondary); font-family: 'Inter', sans-serif; font-weight: 300; max-width: 600px; margin: 0 auto;">
                    Audio Analysis Platform
                </p>
                <p style="font-size: 0.9rem; color: var(--text-muted); font-family: 'Inter', sans-serif; font-weight: 300; margin-top: 0.5rem;">
                    ML-powered key detection ‚Ä¢ Real-time tempo analysis ‚Ä¢ Timeline visualization
                </p>
            </div>
        </header>

        <!-- Compact Upload Area -->
        <div id="uploadArea" class="mb-8 animate-slide-up">
            <div class="bg-white rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-all duration-300 cursor-pointer group">
                <div class="p-6 text-center">
                    <div class="flex items-center justify-center space-x-4">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-gray-200 transition-colors duration-300">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                        </div>
                        <div class="text-left">
                            <h3 class="text-lg font-semibold text-gray-900">Upload Audio File</h3>
                            <p class="text-sm text-gray-600">MP3, WAV, FLAC, AAC ‚Ä¢ Max 750MB</p>
                        </div>
                    </div>
                </div>
            </div>
            <input type="file" id="fileInput" accept="audio/*" class="hidden">
        </div>

        <!-- File Info Bar (Hidden by default) -->
        <div id="fileInfoBar" class="mb-8 hidden">
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l6 6-6 6z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="font-semibold text-blue-900" id="currentFileName">No file selected</p>
                        <p class="text-sm text-blue-600" id="currentFileInfo">Ready to analyze</p>
                    </div>
                </div>
                <button id="changeFileBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    üìÅ Change File
                </button>
            </div>
        </div>

        <!-- Processing Section -->
        <div id="processingSection" class="mb-12 hidden">
            <div class="bg-white rounded-2xl shadow-lg p-8 animate-slide-up">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="processingTitle" class="text-2xl font-semibold text-gray-900">Processing Audio</h2>
                    <div class="flex items-center space-x-4">
                        <div id="processingIndicator" class="animate-pulse-slow">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                        </div>
                        <span id="processingTime" class="text-sm font-mono text-gray-600">0.0s</span>
                        <span id="currentStage" class="text-sm text-gray-600">Starting...</span>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Analysis Progress</span>
                        <span id="progressPercent" class="text-sm font-mono text-gray-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Status -->
                <!-- Real Status -->
                <div id="processingStatus" class="p-3 text-left" style="background: var(--hover-bg); border-radius: 8px;">
                    <p class="text-xs font-mono" style="color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;">Initializing...</p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            
            <!-- Performance Header -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 animate-slide-up">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-semibold text-gray-900">Analysis Complete</h2>
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl px-4 py-2">
                        <span class="text-sm text-gray-600 mr-2">Performance:</span>
                        <span id="realtimeValue" class="text-lg font-bold font-mono text-green-600">0.0x</span>
                        <span class="text-sm text-gray-500 ml-1">realtime</span>
                    </div>
                </div>
            </div>

            <!-- Clean Timeline Overview -->
            <div class="bg-white rounded-2xl shadow-lg mb-8 animate-slide-up">
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-semibold text-gray-900">Timeline Overview</h3>
                        <div class="flex items-center space-x-4 text-sm text-gray-600">
                            <span id="keyDisplay" class="font-mono">Key: --</span>
                            <span id="tempoDisplay" class="font-mono">Tempo: --</span>
                            <span id="waveformInfo" class="font-mono">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="relative">
                        <canvas id="waveformCanvas" class="w-full bg-gray-50 rounded-xl border border-gray-200 cursor-crosshair" style="height: 60px;"></canvas>
                        <div id="waveformControls" class="mt-4 flex items-center justify-between">
                            <div class="flex items-center space-x-6 text-sm text-gray-600">
                                <span id="currentTime" class="font-mono">00:00</span>
                                <span>/</span>
                                <span id="totalDuration" class="font-mono">00:00</span>
                                <span class="text-gray-400">‚Ä¢</span>
                                <span id="regionCount" class="font-mono">0 regions</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="exportBtn" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition-colors duration-200">üìä Export</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Region Cards with Tab System -->
            <div id="regionCardsSection" class="mb-8 animate-slide-up">
                <div class="mb-6">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-2">Region Analysis</h3>
                    <p class="text-gray-600">Click on a region tab to view detailed analysis</p>
                </div>
                
                <!-- Region Tabs -->
                <div id="regionTabs" class="flex flex-wrap gap-2 mb-6 border-b border-gray-200">
                    <!-- Populated by JavaScript -->
                </div>
                
                <!-- Active Region Card -->
                <div id="activeRegionCard" class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">üéµ</div>
                        <p>Select a region tab to view analysis details</p>
                    </div>
                </div>
            </div>

            <!-- Analysis Results removed - only region cards needed -->
        </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="mt-16 border-t border-gray-200 pt-8 pb-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center space-x-6 mb-4 md:mb-0">
                    <a href="mailto:hello@2w12.one" class="text-gray-600 hover:text-gray-900 transition-colors duration-200">Email</a>
                    <a href="#" class="text-gray-600 hover:text-gray-900 transition-colors duration-200">About</a>
                    <a href="#" class="text-gray-600 hover:text-gray-900 transition-colors duration-200">API</a>
                </div>
                <p class="text-gray-500 text-sm font-mono">¬© 2025 2W12 ‚Ä¢ Audio Analysis Platform ‚Ä¢ Real-time Processing</p>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let waveformCanvas, ctx;
        let waveformData = null;
        let downbeats = [];
        let chords = [];
        let contentRegions = [];
        let duration = 0;
        let currentTime = 0;
        let startTime = null;
        let processingTimer = null;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeInterface();
            setupWaveformCanvas();
        });

        function initializeInterface() {
            // Upload area click handler
            document.getElementById('uploadArea').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
            
            // Change file button handler (only if exists)
            const changeFileBtn = document.getElementById('changeFileBtn');
            if (changeFileBtn) {
                changeFileBtn.addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });
            }

            // File input change handler
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            // Drag and drop handlers
            const uploadArea = document.getElementById('uploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('border-blue-300', 'bg-blue-50');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('border-blue-300', 'bg-blue-50');
                }, false);
            });

            uploadArea.addEventListener('drop', handleDrop, false);

            // Control buttons
            document.getElementById('exportBtn').addEventListener('click', exportWaveform);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function setupWaveformCanvas() {
            waveformCanvas = document.getElementById('waveformCanvas');
            console.log('üîß Canvas element found:', !!waveformCanvas);
            
            if (!waveformCanvas) {
                console.error('‚ùå Canvas element not found!');
                return;
            }
            
            ctx = waveformCanvas.getContext('2d');
            console.log('üîß Canvas context created:', !!ctx);
            
            // Set a smaller fixed size for faster rendering
            waveformCanvas.width = 400;
            waveformCanvas.height = 60;
            waveformCanvas.style.width = '100%';
            waveformCanvas.style.height = '60px';
            
            console.log('üîß Canvas size set to:', waveformCanvas.width, 'x', waveformCanvas.height);
            
            // Context is ready
            console.log('üîß Canvas setup complete');
            
            // Handle window resize
            window.addEventListener('resize', resizeCanvas);
            
            // Handle canvas clicks for seeking
            waveformCanvas.addEventListener('click', handleCanvasClick);
        }

        function resizeCanvas() {
            if (!waveformCanvas || !ctx) {
                console.log('üîß Canvas or context not available for resize');
                return;
            }
            
            // Don't resize for now - keep fixed size to test
            console.log('üîß Resize called - keeping fixed size for testing');
            
            // Redraw if we have data
            if (waveformData) {
                drawWaveform();
            }
        }

        function handleCanvasClick(e) {
            if (!duration) return;
            
            const rect = waveformCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const seekTime = (x / rect.width) * duration;
            
            currentTime = Math.max(0, Math.min(seekTime, duration));
            updateTimeDisplay();
            drawWaveform();
        }

        async function processFile(file) {
            console.log(`Processing file: ${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`);
            
            // Hide upload area and show file info bar
            document.getElementById('uploadArea').classList.add('hidden');
            document.getElementById('fileInfoBar').classList.remove('hidden');
            
            // Update file info
            document.getElementById('currentFileName').textContent = file.name;
            document.getElementById('currentFileInfo').textContent = `${(file.size / 1024 / 1024).toFixed(1)} MB ‚Ä¢ Processing...`;
            
            // Add change file button handler now that element exists
            const changeFileBtn = document.getElementById('changeFileBtn');
            if (changeFileBtn && !changeFileBtn.hasAttribute('data-handler-added')) {
                changeFileBtn.addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });
                changeFileBtn.setAttribute('data-handler-added', 'true');
            }
            
            // Show processing section
            document.getElementById('processingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            
            // Start timing
            startTime = Date.now();
            startProcessingTimer();
            
            // File info removed with analysis results card
            
            // Show filename in processing title
            const processingTitle = document.getElementById('processingTitle');
            if (processingTitle) {
                processingTitle.textContent = `Processing: ${file.name}`;
            }
            
            try {
                // Create form data
                const formData = new FormData();
                formData.append('file', file);
                
                // Update progress
                updateProgress(10, 'Uploading file...', 'upload');
                
                // Use ONLY the visualization endpoint (includes all analysis + visualization)
                // This eliminates the redundant double processing!
                updateProgress(20, 'Starting analysis with visualization...', 'analyzing');
                
                // Show progress during analysis
                const progressInterval = setInterval(() => {
                    const elapsed = (Date.now() - startTime) / 1000;
                    const estimatedProgress = Math.min(85, 20 + (elapsed * 5)); // Gradual progress
                    updateProgress(estimatedProgress, `Analyzing audio... (${elapsed.toFixed(1)}s)`, 'analyzing');
                }, 1000);
                
                const response = await fetch('/api/audio/analyze-visualization', {
                    method: 'POST',
                    body: formData
                });
                
                clearInterval(progressInterval);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                updateProgress(90, 'Processing complete, loading results...', 'complete');
                
                const result = await response.json();
                
                updateProgress(95, 'Analysis complete! Loading UI...', 'complete');
                
                // Show analysis results immediately
                showAnalysisResults(result);
                
                // Process the result immediately
                console.log('üöÄ Single API call completed - 50% faster processing!');
                console.log('üîç Analysis + visualization data received:', result);
                
                // Stop timer and load results immediately
                stopProcessingTimer();
                loadResults(result);
                loadRegionAnalysis(result);
                
                updateProgress(100, 'Complete!', 'complete');
                
                // ‚úÖ PERFORMANCE IMPROVEMENT: Eliminated redundant double analysis
                // This saves ~50% processing time by using a single API call
                
            } catch (error) {
                console.error('Processing failed:', error);
                updateProgress(0, `Error: ${error.message}`, null);
                stopProcessingTimer();
            }
        }

        function startProcessingTimer() {
            const currentStage = document.getElementById('currentStage');
            const processingTitle = document.getElementById('processingTitle');
            const processingIndicator = document.getElementById('processingIndicator');
            
            // Show upload stage initially
            currentStage.textContent = 'Starting...';
            currentStage.className = 'text-sm';
            currentStage.style.color = 'var(--text-secondary)';
            processingTitle.textContent = 'Processing Audio';
            processingIndicator.className = 'animate-pulse-slow';
            
            processingTimer = setInterval(() => {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                document.getElementById('processingTime').textContent = elapsed + 's';
            }, 100);
        }
        
        function updateRealProgress(stage, progress, message) {
            const currentStage = document.getElementById('currentStage');
            const processingTitle = document.getElementById('processingTitle');
            const processingIndicator = document.getElementById('processingIndicator');
            
            console.log(`üîÑ Real progress update: ${stage} - ${progress}% - ${message}`);
            
            // Update stage indicator
            currentStage.textContent = stage;
            currentStage.style.color = 'var(--text-secondary)';
            
            // Update title based on stage with better mapping
            if (stage.includes('Upload') || stage.includes('upload')) {
                processingTitle.textContent = 'Uploading Audio';
                processingIndicator.innerHTML = '<div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse-slow"></div>';
            } else if (stage.includes('Loading') || stage.includes('loading')) {
                processingTitle.textContent = 'Loading Audio';
                processingIndicator.innerHTML = '<div class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>';
            } else if (stage.includes('Audio Analysis') || stage.includes('analyzing') || stage.includes('Analysis')) {
                processingTitle.textContent = 'Content-Aware Analysis';
                processingIndicator.innerHTML = '<div class="w-3 h-3 bg-green-500 rounded-full animate-spin"></div>';
            } else if (stage.includes('Complete') || stage.includes('complete')) {
                processingTitle.textContent = 'Analysis Complete';
                processingIndicator.innerHTML = '<div class="w-3 h-3 bg-green-500 rounded-full"></div>';
            } else {
                processingTitle.textContent = 'Processing Audio';
                processingIndicator.innerHTML = '<div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>';
            }
            
            // Update progress bar and status with real data
            updateProgress(progress, message, null);
        }

        function stopProcessingTimer() {
            if (processingTimer) {
                clearInterval(processingTimer);
                processingTimer = null;
            }
            
            // Final progress update
            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
            updateProgress(100, `Analysis complete! (${elapsed}s)`, 'complete');
            
            // Update to completed state
            const currentStage = document.getElementById('currentStage');
            const processingTitle = document.getElementById('processingTitle');
            const processingIndicator = document.getElementById('processingIndicator');
            
            currentStage.textContent = `Complete (${elapsed}s)`;
            currentStage.className = 'text-sm text-green-600';
            processingTitle.textContent = 'Analysis Complete';
            processingIndicator.className = 'w-3 h-3 bg-green-500 rounded-full';
        }

        function showAnalysisResults(analysisData) {
            // Show key analysis results immediately
            console.log('üöÄ Showing analysis results immediately:', analysisData);
            
            const analysis = analysisData.analysis;
            if (!analysis) return;
            
            // Show processing section is complete
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Show key results immediately
            updateTimeDisplay();
            createMetrics(analysis);
            
            // Show basic info
            const processingTime = analysis?.response_time || ((Date.now() - startTime) / 1000);
            console.log('Processing time:', processingTime.toFixed(1) + 's');
            
            // No need to show loading message - visualization data is already available!
            console.log('üé® Visualization data ready for immediate rendering');
        }

        function updateProgress(percentage, message, step) {
            // Update progress bar with portfolio styling + elapsed time
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const processingStatus = document.getElementById('processingStatus');
            
            if (progressBar) {
                progressBar.style.width = Math.round(percentage) + '%';
            }
            if (progressPercent) {
                progressPercent.textContent = Math.round(percentage) + '%';
            }
            if (processingStatus) {
                // Add elapsed time to progress display
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                processingStatus.innerHTML = `<p class="text-xs font-mono" style="color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;">${message} (${elapsed}s)</p>`;
            }
        }

        function loadResults(result) {
            const analysis = result.analysis;
            const visualization = result.visualization;
            
            // Hide processing, show results
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Calculate and display performance with defensive checks
            const processingTime = analysis?.response_time || ((Date.now() - startTime) / 1000);
            const audioDuration = visualization?.waveform?.duration || 0;
            const realtimeFactor = audioDuration > 0 ? (audioDuration / processingTime).toFixed(1) : '0.0';
            
            document.getElementById('realtimeValue').textContent = realtimeFactor + 'x';
            
            // Load waveform data with defensive checks
            waveformData = visualization?.waveform || {};
            downbeats = visualization?.downbeats?.times || [];
            chords = visualization?.chords?.events || [];
            contentRegions = result.analysis?.content_analysis?.regions || [];
            duration = waveformData?.duration || 0;
            currentTime = 0;
            
            // Debug logging
            console.log('üìä DEBUG: Analysis data loaded');
            console.log('üìä Downbeats:', downbeats.length);
            console.log('üìä Chords:', chords.length);
            console.log('üìä Content regions:', contentRegions.length);
            console.log('üìä Duration:', duration);
            console.log('üìä Content regions data:', contentRegions);
            if (chords.length > 0) {
                console.log('üìä First 5 chords:', chords.slice(0, 5));
            }
            
            // Update info displays
            updateTimeDisplay();
            document.getElementById('regionCount').textContent = `${contentRegions.length} regions`;
            document.getElementById('waveformInfo').textContent = `${waveformData.width} points ‚Ä¢ ${duration.toFixed(1)}s`;
            
            // Technical info removed with analysis results card
            
            // Create metrics
            createMetrics(analysis);
            
            // Draw waveform immediately
            drawWaveform();
        }

        function createMetrics(analysis) {
            // Debug: Log the full analysis object to see what's available
            console.log('üîç Full analysis object:', analysis);
            
            // Check for ML analysis results in different locations
            const mlKey = analysis.ml_key || analysis.key || analysis.enhanced_key || 'Unknown';
            const mlMode = analysis.ml_mode || analysis.mode || analysis.enhanced_mode || 'Unknown';
            const mlTempo = analysis.ml_tempo || analysis.tempo || analysis.enhanced_tempo || 'Unknown';
            
            console.log('üéπ Key detection results:', { mlKey, mlMode, mlTempo });
            
            const fullKey = mlKey !== 'Unknown' && mlMode !== 'Unknown' ? `${mlKey} ${mlMode}` : 'Unknown';
            const tempoDisplay = typeof mlTempo === 'number' ? `${Math.round(mlTempo)} BPM` : mlTempo;
            
            // Update timeline header with key metrics
            document.getElementById('keyDisplay').textContent = `Key: ${fullKey}`;
            document.getElementById('tempoDisplay').textContent = `Tempo: ${tempoDisplay}`;
        }

        function drawWaveform() {
            console.log('üé® drawWaveform() called');
            
            if (!waveformData || !waveformData.peaks) {
                console.log('‚ö†Ô∏è No waveform data to draw');
                return;
            }
            
            // SIMPLE APPROACH: Get canvas actual dimensions
            const width = waveformCanvas.width;
            const height = waveformCanvas.height;
            
            console.log(`üé® Drawing on ${width}x${height} canvas with ${waveformData.peaks.length} peaks`);
            
            // Clear canvas with white background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            
            // Draw region markers FIRST as background
            if (contentRegions && contentRegions.length > 0) {
                console.log(`üéØ Drawing ${contentRegions.length} region markers as background`);
                
                contentRegions.forEach((region, index) => {
                    const startX = (region.start / duration) * width;
                    const endX = (region.end / duration) * width;
                    const regionWidth = endX - startX;
                    
                    // Different colors for different region types
                    const regionColor = region.type === 'silence' ? '#f3f4f6' : 
                                      region.type === 'sound' ? '#dbeafe' : 
                                      region.type === 'sound_short' ? '#fef3c7' : '#e5e7eb';
                    
                    // Draw region background
                    ctx.fillStyle = regionColor;
                    ctx.fillRect(startX, 0, regionWidth, height);
                    
                    // Draw region border
                    ctx.strokeStyle = region.analyzed ? '#10b981' : '#6b7280';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(startX, 0);
                    ctx.lineTo(startX, height);
                    ctx.stroke();
                    
                    // Draw region label
                    ctx.fillStyle = '#374151';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    const labelX = startX + regionWidth / 2;
                    ctx.fillText(`R.${index + 1}`, labelX, 15);
                    
                    // Draw region type
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '10px Arial';
                    ctx.fillText(region.type, labelX, 30);
                });
            }
            
            const centerY = height / 2;
            const peaks = waveformData.peaks;
            
            // Debug: Log some peak values
            const nonZeroPeaks = peaks.filter(p => Math.abs(p) > 0.001);
            console.log(`üîç Found ${nonZeroPeaks.length} non-zero peaks out of ${peaks.length} total`);
            
            // BETTER WAVEFORM: Draw as filled area
            if (peaks.length > 0) {
                // Find non-zero peaks for better scaling
                const nonZeroPeaks = peaks.filter(p => Math.abs(p) > 0.001);
                const maxPeak = nonZeroPeaks.length > 0 ? Math.max(...nonZeroPeaks.map(p => Math.abs(p))) : Math.max(...peaks.map(p => Math.abs(p)));
                const scale = maxPeak > 0 ? 80 / maxPeak : 1000; // Much bigger scale if peaks are tiny
                
                console.log(`üé® Max peak: ${maxPeak.toFixed(6)}, scale: ${scale.toFixed(2)}, non-zero peaks: ${nonZeroPeaks.length}`);
                
                // Draw waveform as filled shape with reduced resolution
                ctx.fillStyle = '#0066cc40'; // Semi-transparent blue
                ctx.strokeStyle = '#0066cc';
                ctx.lineWidth = 1;
                ctx.beginPath();
                
                // Start from bottom left
                ctx.moveTo(0, centerY);
                
                // Draw top edge (peaks) - sample every 4th point for faster rendering
                const step = Math.max(1, Math.floor(peaks.length / width));
                for (let i = 0; i < peaks.length; i += step) {
                    const x = (i / peaks.length) * width;
                    const y = centerY - (peaks[i] * scale);
                    ctx.lineTo(x, y);
                }
                
                // Draw to bottom right and back to start
                ctx.lineTo(width, centerY);
                ctx.lineTo(0, centerY);
                ctx.closePath();
                
                ctx.fill();
                ctx.stroke();
                console.log(`üé® Drew filled waveform with reduced resolution`);
            }
            
            // Draw center line
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            
            // Madmom beat markers removed per user request

            // Draw current time cursor
            if (currentTime > 0) {
                const x = (currentTime / duration) * width;
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.setLineDash([4, 4]);
                
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }

        function updateTimeDisplay() {
            document.getElementById('currentTime').textContent = formatTime(currentTime);
            document.getElementById('totalDuration').textContent = formatTime(duration);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function getChordColor(quality) {
            const colors = {
                'major': '#3B82F6',      // Blue
                'minor': '#EF4444',      // Red
                'dominant': '#8B5CF6',   // Purple
                'diminished': '#6B7280', // Gray
                'augmented': '#F59E0B',  // Orange/Yellow
                'suspended': '#10B981'   // Green
            };
            return colors[quality] || '#6B7280';
        }

        function exportWaveform() {
            if (waveformCanvas) {
                const link = document.createElement('a');
                link.download = 'waveform-analysis.png';
                link.href = waveformCanvas.toDataURL();
                link.click();
            }
        }

        function resetAnalysis() {
            // Hide all sections except upload
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('regionAnalysisSection').classList.add('hidden');
            
            // Reset data
            waveformData = null;
            downbeats = [];
            chords = [];
            duration = 0;
            currentTime = 0;
            
            // Clear canvas
            if (ctx) {
                const rect = waveformCanvas.getBoundingClientRect();
                ctx.fillStyle = '#f9fafb';
                ctx.fillRect(0, 0, rect.width, 200);
            }
            
            // Reset file input
            document.getElementById('fileInput').value = '';
            
            // Stop any running timer
            stopProcessingTimer();
        }

        let currentActiveRegion = 0;
        let regionData = [];
        
        function loadRegionAnalysis(result) {
            const regionCardsSection = document.getElementById('regionCardsSection');
            const regionTabs = document.getElementById('regionTabs');
            
            // Check if region analysis is available
            if (result.analysis?.region_analysis?.regions && result.analysis.region_analysis.regions.length > 0) {
                regionCardsSection.classList.remove('hidden');
                regionData = result.analysis.region_analysis.regions;
                
                // Clear existing content
                regionTabs.innerHTML = '';
                
                // Create tabs for each region
                regionData.forEach((region, index) => {
                    const regionInfo = region.region_info;
                    
                    const tab = document.createElement('button');
                    tab.className = `px-4 py-2 text-sm font-medium rounded-t-lg transition-all duration-200 ${
                        index === 0 ? 'bg-white border-b-2 border-blue-500 text-blue-600' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                    }`;
                    tab.textContent = `R.${regionInfo.region_number}`;
                    tab.onclick = () => showRegionDetails(index);
                    
                    regionTabs.appendChild(tab);
                });
                
                // Show first region by default
                showRegionDetails(0);
                    
                console.log(`‚úÖ Created ${result.analysis.region_analysis.regions.length} region tabs`);
            } else {
                regionCardsSection.classList.add('hidden');
                console.log('‚ùå No region analysis data available');
            }
        }
        
        function showRegionDetails(index) {
            if (index < 0 || index >= regionData.length) return;
            
            currentActiveRegion = index;
            const region = regionData[index];
            const regionInfo = region.region_info;
            const analysisResults = region.analysis_results;
            
            // Update tab styles
            const tabs = document.querySelectorAll('#regionTabs button');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.className = 'px-4 py-2 text-sm font-medium rounded-t-lg bg-white border-b-2 border-blue-500 text-blue-600 transition-all duration-200';
                } else {
                    tab.className = 'px-4 py-2 text-sm font-medium rounded-t-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all duration-200';
                }
            });
            
            // Get analysis info
            const keyInfo = analysisResults.key_detection || {};
            const tempoInfo = analysisResults.tempo_detection || {};
            const downbeatInfo = analysisResults.downbeat_detection || {};
            const danceInfo = analysisResults.danceability || {};
            
            // Update active region card
            const activeRegionCard = document.getElementById('activeRegionCard');
            activeRegionCard.innerHTML = `
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-xl font-semibold" style="color: var(--text-primary); font-family: 'Inter', sans-serif;">R.${regionInfo.region_number}</h4>
                        <span class="text-xs font-mono px-2 py-1 rounded" style="color: var(--text-muted); background: var(--hover-bg); font-family: 'JetBrains Mono', monospace;">
                            ${regionInfo.content_type.toUpperCase()}
                        </span>
                    </div>
                    
                    <!-- Region Info -->
                    <div class="mb-4" style="background: var(--hover-bg); border-radius: 8px; padding: 12px;">
                        <div class="flex items-center justify-between text-xs" style="color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;">
                            <span>${formatTime(regionInfo.start_time)} - ${formatTime(regionInfo.end_time)}</span>
                            <span>${regionInfo.duration.toFixed(1)}s</span>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    ${keyInfo.key ? `
                        <div class="bg-purple-50 rounded-lg p-3 border border-purple-200">
                            <div class="text-xs text-purple-600 mb-1">Key</div>
                            <div class="text-lg font-bold text-purple-800">${keyInfo.key}</div>
                            <div class="text-xs text-purple-600">${(keyInfo.confidence * 100).toFixed(0)}%</div>
                        </div>
                    ` : ''}
                    
                    ${tempoInfo.tempo ? `
                        <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                            <div class="text-xs text-blue-600 mb-1">Tempo</div>
                            <div class="text-lg font-bold text-blue-800">${tempoInfo.tempo.toFixed(0)} <span class="text-xs font-normal">BPM</span></div>
                            <div class="text-xs text-blue-600">${(tempoInfo.confidence * 100).toFixed(0)}%</div>
                        </div>
                    ` : ''}
                    
                    ${downbeatInfo.downbeat_count !== undefined ? `
                        <div class="bg-green-50 rounded-lg p-3 border border-green-200">
                            <div class="text-xs text-green-600 mb-1">Downbeats</div>
                            <div class="text-lg font-bold text-green-800">${downbeatInfo.downbeat_count}</div>
                            <div class="text-xs text-green-600">detected</div>
                        </div>
                    ` : ''}
                    
                    ${danceInfo.score !== undefined ? `
                        <div class="bg-orange-50 rounded-lg p-3 border border-orange-200">
                            <div class="text-xs text-orange-600 mb-1">Dance</div>
                            <div class="text-lg font-bold text-orange-800">${(danceInfo.score * 100).toFixed(0)}%</div>
                            <div class="text-xs text-orange-600">potential</div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Waveform rendering removed from region cards per user request
        }
        
        // Region waveform rendering removed per user request
    </script>
</body>
</html>