<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2W12 Audio Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'Menlo', 'Monaco', 'monospace']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'progress': 'progress 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        progress: { '0%': { transform: 'scaleX(0)' }, '100%': { transform: 'scaleX(1)' } }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-900 font-sans min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header -->
        <header class="text-center mb-12 animate-fade-in">
            <h1 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-4 tracking-tight">
                2W12 Audio Analysis
            </h1>
            <p class="text-xl text-gray-600 font-light max-w-2xl mx-auto leading-relaxed">
                Professional audio analysis with real-time waveform visualization and precise downbeat detection
            </p>
        </header>

        <!-- Upload Area -->
        <div id="uploadArea" class="mb-12 animate-slide-up">
            <div class="bg-white rounded-2xl shadow-lg border-2 border-dashed border-gray-200 hover:border-gray-300 transition-all duration-300 hover:shadow-xl cursor-pointer group">
                <div class="p-12 text-center">
                    <div class="w-16 h-16 mx-auto mb-6 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-gray-200 transition-colors duration-300">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Upload Audio File</h3>
                    <p class="text-gray-600 mb-4">Drag and drop your audio file here, or click to browse</p>
                    <p class="text-sm text-gray-500">Supports MP3, WAV, FLAC, AAC • Maximum 150MB</p>
                </div>
            </div>
            <input type="file" id="fileInput" accept="audio/*" class="hidden">
        </div>

        <!-- Processing Section -->
        <div id="processingSection" class="mb-12 hidden">
            <div class="bg-white rounded-2xl shadow-lg p-8 animate-slide-up">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold text-gray-900">Processing Audio</h2>
                    <div class="flex items-center space-x-4">
                        <div class="animate-pulse-slow">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                        </div>
                        <span id="processingTime" class="text-sm font-mono text-gray-600">0.0s</span>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Analysis Progress</span>
                        <span id="progressPercent" class="text-sm font-mono text-gray-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Status -->
                <div id="processingStatus" class="bg-gray-50 rounded-xl p-4 text-center">
                    <p class="text-gray-600">Initializing analysis...</p>
                </div>
                
                <!-- Processing Steps -->
                <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div id="step-upload" class="processing-step opacity-50">
                        <div class="text-center">
                            <div class="w-12 h-12 mx-auto mb-2 bg-gray-100 rounded-full flex items-center justify-center">
                                <div class="w-6 h-6 border-2 border-gray-300 rounded-full"></div>
                            </div>
                            <p class="text-xs font-medium text-gray-600">Upload</p>
                        </div>
                    </div>
                    <div id="step-analysis" class="processing-step opacity-50">
                        <div class="text-center">
                            <div class="w-12 h-12 mx-auto mb-2 bg-gray-100 rounded-full flex items-center justify-center">
                                <div class="w-6 h-6 border-2 border-gray-300 rounded-full"></div>
                            </div>
                            <p class="text-xs font-medium text-gray-600">AudioFlux</p>
                        </div>
                    </div>
                    <div id="step-downbeats" class="processing-step opacity-50">
                        <div class="text-center">
                            <div class="w-12 h-12 mx-auto mb-2 bg-gray-100 rounded-full flex items-center justify-center">
                                <div class="w-6 h-6 border-2 border-gray-300 rounded-full"></div>
                            </div>
                            <p class="text-xs font-medium text-gray-600">Downbeats</p>
                        </div>
                    </div>
                    <div id="step-complete" class="processing-step opacity-50">
                        <div class="text-center">
                            <div class="w-12 h-12 mx-auto mb-2 bg-gray-100 rounded-full flex items-center justify-center">
                                <div class="w-6 h-6 border-2 border-gray-300 rounded-full"></div>
                            </div>
                            <p class="text-xs font-medium text-gray-600">Complete</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            
            <!-- Performance Header -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 animate-slide-up">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-semibold text-gray-900">Analysis Complete</h2>
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl px-4 py-2">
                        <span class="text-sm text-gray-600 mr-2">Performance:</span>
                        <span id="realtimeValue" class="text-lg font-bold font-mono text-green-600">0.0x</span>
                        <span class="text-sm text-gray-500 ml-1">realtime</span>
                    </div>
                </div>
            </div>

            <!-- Waveform Visualization -->
            <div class="bg-white rounded-2xl shadow-lg mb-8 animate-slide-up">
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-semibold text-gray-900">Waveform, Downbeats & Chords</h3>
                        <div class="flex items-center space-x-4 text-sm text-gray-600">
                            <span id="waveformInfo" class="font-mono">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="relative">
                        <canvas id="waveformCanvas" class="w-full bg-gray-50 rounded-xl border border-gray-200 cursor-crosshair" style="height: 200px;"></canvas>
                        <div id="waveformControls" class="mt-4 flex items-center justify-between">
                            <div class="flex items-center space-x-6 text-sm text-gray-600">
                                <span id="currentTime" class="font-mono">00:00</span>
                                <span>/</span>
                                <span id="totalDuration" class="font-mono">00:00</span>
                                <span class="text-gray-400">•</span>
                                <span id="downbeatCount" class="font-mono">0 downbeats</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="exportBtn" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition-colors duration-200">Export PNG</button>
                                <button id="resetBtn" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition-colors duration-200">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Results Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                
                <!-- Key Metrics -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-lg p-6 animate-slide-up">
                        <h3 class="text-xl font-semibold text-gray-900 mb-6">Analysis Results</h3>
                        <div id="metricsGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Technical Details -->
                <div class="bg-white rounded-2xl shadow-lg p-6 animate-slide-up">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Technical Info</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="text-gray-600 text-sm">Pipeline</span>
                            <span id="tech-pipeline" class="font-mono text-sm text-gray-900">AudioFlux</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="text-gray-600 text-sm">GPU Acceleration</span>
                            <span id="tech-gpu" class="font-mono text-sm text-gray-900">Enabled</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="text-gray-600 text-sm">Sample Rate</span>
                            <span id="tech-samplerate" class="font-mono text-sm text-gray-900">22 kHz</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="text-gray-600 text-sm">File Size</span>
                            <span id="tech-filesize" class="font-mono text-sm text-gray-900">0 MB</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-600 text-sm">Processing Time</span>
                            <span id="tech-processtime" class="font-mono text-sm text-gray-900">0.0s</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let waveformCanvas, ctx;
        let waveformData = null;
        let downbeats = [];
        let chords = [];
        let duration = 0;
        let currentTime = 0;
        let startTime = null;
        let processingTimer = null;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeInterface();
            setupWaveformCanvas();
        });

        function initializeInterface() {
            // Upload area click handler
            document.getElementById('uploadArea').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            // File input change handler
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            // Drag and drop handlers
            const uploadArea = document.getElementById('uploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('border-blue-300', 'bg-blue-50');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('border-blue-300', 'bg-blue-50');
                }, false);
            });

            uploadArea.addEventListener('drop', handleDrop, false);

            // Control buttons
            document.getElementById('exportBtn').addEventListener('click', exportWaveform);
            document.getElementById('resetBtn').addEventListener('click', resetAnalysis);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function setupWaveformCanvas() {
            waveformCanvas = document.getElementById('waveformCanvas');
            ctx = waveformCanvas.getContext('2d');
            
            // Set canvas size to match container
            resizeCanvas();
            
            // Handle window resize
            window.addEventListener('resize', resizeCanvas);
            
            // Handle canvas clicks for seeking
            waveformCanvas.addEventListener('click', handleCanvasClick);
        }

        function resizeCanvas() {
            const container = waveformCanvas.parentElement;
            const rect = container.getBoundingClientRect();
            
            // Set display size
            waveformCanvas.style.width = '100%';
            waveformCanvas.style.height = '200px';
            
            // Set actual canvas size for drawing (high DPI)
            const dpr = window.devicePixelRatio || 1;
            waveformCanvas.width = rect.width * dpr;
            waveformCanvas.height = 200 * dpr;
            
            // Scale context for high DPI
            ctx.scale(dpr, dpr);
            
            // Redraw if we have data
            if (waveformData) {
                drawWaveform();
            }
        }

        function handleCanvasClick(e) {
            if (!duration) return;
            
            const rect = waveformCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const seekTime = (x / rect.width) * duration;
            
            currentTime = Math.max(0, Math.min(seekTime, duration));
            updateTimeDisplay();
            drawWaveform();
        }

        async function processFile(file) {
            console.log(`Processing file: ${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`);
            
            // Show processing section
            document.getElementById('processingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            
            // Start timing
            startTime = Date.now();
            startProcessingTimer();
            
            // Update file info
            document.getElementById('tech-filesize').textContent = `${(file.size / 1024 / 1024).toFixed(1)} MB`;
            
            try {
                // Create form data
                const formData = new FormData();
                formData.append('file', file);
                
                // Update progress
                updateProgress(10, 'Uploading file...', 'upload');
                
                // Make API request
                const response = await fetch('/api/audio/analyze-visualization', {
                    method: 'POST',
                    body: formData
                });
                
                updateProgress(40, 'AudioFlux processing...', 'analysis');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                updateProgress(70, 'Extracting downbeats...', 'downbeats');
                
                const result = await response.json();
                
                updateProgress(100, 'Analysis complete!', 'complete');
                
                // Debug: Log the visualization data
                console.log('🔍 Visualization data received:', result.visualization);
                console.log('🔍 Waveform peaks sample:', result.visualization?.waveform?.peaks?.slice(0, 10));
                console.log('🔍 Waveform peaks middle:', result.visualization?.waveform?.peaks?.slice(100, 105));
                console.log('🔍 Downbeats:', result.visualization?.downbeats?.times?.slice(0, 5));
                console.log('🔍 Chords detected:', result.visualization?.chords?.events?.length || 0);
                console.log('🔍 Chord events:', result.visualization?.chords?.events);
                
                // Stop timer
                stopProcessingTimer();
                
                // Load results
                setTimeout(() => {
                    loadResults(result);
                }, 500);
                
            } catch (error) {
                console.error('Processing failed:', error);
                updateProgress(0, `Error: ${error.message}`, null);
                stopProcessingTimer();
            }
        }

        function startProcessingTimer() {
            processingTimer = setInterval(() => {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                document.getElementById('processingTime').textContent = elapsed + 's';
            }, 100);
        }

        function stopProcessingTimer() {
            if (processingTimer) {
                clearInterval(processingTimer);
                processingTimer = null;
            }
        }

        function updateProgress(percentage, message, step) {
            // Update progress bar
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressPercent').textContent = percentage + '%';
            document.getElementById('processingStatus').innerHTML = `<p class="text-gray-600">${message}</p>`;
            
            // Update step indicators
            const steps = ['upload', 'analysis', 'downbeats', 'complete'];
            const currentStepIndex = steps.indexOf(step);
            
            steps.forEach((stepName, index) => {
                const stepElement = document.getElementById(`step-${stepName}`);
                const circle = stepElement.querySelector('.w-6.h-6');
                
                if (index <= currentStepIndex) {
                    stepElement.classList.remove('opacity-50');
                    stepElement.classList.add('opacity-100');
                    circle.classList.remove('border-gray-300');
                    circle.classList.add('border-blue-500', 'bg-blue-500');
                } else {
                    stepElement.classList.add('opacity-50');
                    circle.classList.remove('border-blue-500', 'bg-blue-500');
                    circle.classList.add('border-gray-300');
                }
            });
        }

        function loadResults(result) {
            const analysis = result.analysis;
            const visualization = result.visualization;
            
            // Hide processing, show results
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Calculate and display performance
            const processingTime = analysis.response_time || ((Date.now() - startTime) / 1000);
            const audioDuration = visualization.waveform.duration;
            const realtimeFactor = audioDuration > 0 ? (audioDuration / processingTime).toFixed(1) : '0.0';
            
            document.getElementById('realtimeValue').textContent = realtimeFactor + 'x';
            document.getElementById('tech-processtime').textContent = processingTime.toFixed(1) + 's';
            
            // Load waveform data
            waveformData = visualization.waveform;
            downbeats = visualization.downbeats.times || [];
            chords = visualization.chords?.events || [];
            duration = waveformData.duration;
            currentTime = 0;
            
            // Update info displays
            updateTimeDisplay();
            document.getElementById('downbeatCount').textContent = `${downbeats.length} downbeats • ${chords.length} chords`;
            document.getElementById('waveformInfo').textContent = `${waveformData.width} points • ${duration.toFixed(1)}s`;
            
            // Update technical info
            document.getElementById('tech-pipeline').textContent = visualization.metadata?.extraction_method || 'AudioFlux';
            document.getElementById('tech-gpu').textContent = result.features?.audioflux_visualization ? 'Enabled' : 'Disabled';
            document.getElementById('tech-samplerate').textContent = `${(waveformData.sample_rate / 1000).toFixed(0)} kHz`;
            
            // Create metrics
            createMetrics(analysis);
            
            // Draw waveform
            drawWaveform();
        }

        function createMetrics(analysis) {
            const metrics = [
                { label: 'Key', value: analysis.ml_key || analysis.key || 'N/A' },
                { label: 'Tempo', value: analysis.ml_tempo || analysis.tempo || 'N/A' },
                { label: 'Danceability', value: analysis.ml_danceability ? `${(analysis.ml_danceability * 100).toFixed(0)}%` : 'N/A' },
                { label: 'Time Signature', value: analysis.madmom_meter_detection || 'N/A' },
                { label: 'Downbeats', value: analysis.madmom_downbeat_count || 'N/A' },
                { label: 'Energy', value: analysis.rms_energy ? analysis.rms_energy.toFixed(2) : 'N/A' }
            ];
            
            const grid = document.getElementById('metricsGrid');
            grid.innerHTML = metrics.map(metric => `
                <div class="bg-gray-50 rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-gray-900 mb-1">${metric.value}</div>
                    <div class="text-sm text-gray-600 uppercase tracking-wide">${metric.label}</div>
                </div>
            `).join('');
        }

        function drawWaveform() {
            if (!waveformData || !waveformData.peaks) {
                console.log('⚠️ No waveform data to draw');
                return;
            }
            
            const rect = waveformCanvas.getBoundingClientRect();
            const width = rect.width;
            const height = 200;
            
            console.log(`🎨 Drawing waveform: ${waveformData.peaks.length} points on ${width}x${height} canvas`);
            
            // Clear canvas
            ctx.fillStyle = '#f9fafb';
            ctx.fillRect(0, 0, width, height);
            
            const centerY = height / 2;
            const peaks = waveformData.peaks;
            const valleys = waveformData.valleys || peaks.map(p => -Math.abs(p));
            
            // Debug: Log some peak values
            const nonZeroPeaks = peaks.filter(p => Math.abs(p) > 0.001);
            console.log(`🔍 Found ${nonZeroPeaks.length} non-zero peaks out of ${peaks.length} total`);
            if (nonZeroPeaks.length > 0) {
                console.log(`🔍 Sample non-zero peaks:`, nonZeroPeaks.slice(0, 5));
                console.log(`🔍 Max peak value:`, Math.max(...peaks));
                console.log(`🔍 Min peak value:`, Math.min(...peaks));
            }
            
            // Find first non-zero peak for better visualization
            const firstNonZeroIndex = peaks.findIndex(p => Math.abs(p) > 0.001);
            if (firstNonZeroIndex > 0) {
                console.log(`🔍 First non-zero peak at index ${firstNonZeroIndex} (${(firstNonZeroIndex / peaks.length * 100).toFixed(1)}% through file)`);
            }
            
            // Draw waveform
            if (peaks.length > 0) {
                ctx.strokeStyle = '#6b7280';
                ctx.lineWidth = 1;
                ctx.fillStyle = '#9ca3af20';
                
                ctx.beginPath();
                
                // Draw peaks
                for (let i = 0; i < peaks.length; i++) {
                    const x = (i / peaks.length) * width;
                    const y = centerY - (peaks[i] * centerY * 0.8);
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                // Draw valleys (reverse)
                for (let i = peaks.length - 1; i >= 0; i--) {
                    const x = (i / peaks.length) * width;
                    const y = centerY - (valleys[i] * centerY * 0.8);
                    ctx.lineTo(x, y);
                }
                
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }
            
            // Draw center line
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            
            // Draw downbeats
            if (downbeats.length > 0 && duration > 0) {
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 2;
                ctx.globalAlpha = 0.8;
                
                downbeats.forEach((beatTime, index) => {
                    const x = (beatTime / duration) * width;
                    
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                    
                    // Beat numbers (every 4th)
                    if (index % 4 === 0) {
                        ctx.fillStyle = '#ef4444';
                        ctx.font = '10px JetBrains Mono';
                        ctx.fillText(`${index + 1}`, x + 2, 15);
                    }
                });
                
                ctx.globalAlpha = 1;
            }
            
            // Draw chord progression
            if (chords.length > 0 && duration > 0) {
                console.log(`🎵 Drawing ${chords.length} chords`);
                
                chords.forEach((chord, index) => {
                    const startX = (chord.start / duration) * width;
                    const endX = (chord.end / duration) * width;
                    const chordWidth = endX - startX;
                    
                    // Get color based on chord quality
                    const color = getChordColor(chord.quality);
                    
                    // Draw chord block (semi-transparent)
                    ctx.fillStyle = color + '30';  // 30% opacity
                    ctx.fillRect(startX, height - 40, chordWidth, 25);
                    
                    // Draw chord border
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1;
                    ctx.strokeRect(startX, height - 40, chordWidth, 25);
                    
                    // Draw chord label
                    if (chordWidth > 30) {  // Only show label if chord is wide enough
                        ctx.fillStyle = color;
                        ctx.font = '12px JetBrains Mono';
                        ctx.textAlign = 'center';
                        ctx.fillText(chord.chord, startX + chordWidth/2, height - 22);
                        ctx.textAlign = 'left';  // Reset alignment
                    }
                });
                
                console.log(`✅ Drew ${chords.length} chord blocks`);
            }
            
            // Draw current time cursor
            if (currentTime > 0) {
                const x = (currentTime / duration) * width;
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.setLineDash([4, 4]);
                
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }

        function updateTimeDisplay() {
            document.getElementById('currentTime').textContent = formatTime(currentTime);
            document.getElementById('totalDuration').textContent = formatTime(duration);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function getChordColor(quality) {
            const colors = {
                'major': '#3B82F6',      // Blue
                'minor': '#EF4444',      // Red
                'dominant': '#8B5CF6',   // Purple
                'diminished': '#6B7280', // Gray
                'augmented': '#F59E0B',  // Orange/Yellow
                'suspended': '#10B981'   // Green
            };
            return colors[quality] || '#6B7280';
        }

        function exportWaveform() {
            if (waveformCanvas) {
                const link = document.createElement('a');
                link.download = 'waveform-analysis.png';
                link.href = waveformCanvas.toDataURL();
                link.click();
            }
        }

        function resetAnalysis() {
            // Hide all sections except upload
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            
            // Reset data
            waveformData = null;
            downbeats = [];
            chords = [];
            duration = 0;
            currentTime = 0;
            
            // Clear canvas
            if (ctx) {
                const rect = waveformCanvas.getBoundingClientRect();
                ctx.fillStyle = '#f9fafb';
                ctx.fillRect(0, 0, rect.width, 200);
            }
            
            // Reset file input
            document.getElementById('fileInput').value = '';
            
            // Stop any running timer
            stopProcessingTimer();
        }
    </script>
</body>
</html>